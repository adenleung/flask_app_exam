<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Re:Connect SG</title>
  <link rel="stylesheet" href="/static/css/styles.css">
  <link rel="stylesheet" href="/static/css/dashboard.css">
  <link rel="stylesheet" href="/static/css/tabs.css">
  <link rel="stylesheet" href="/static/css/ui-kit.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/messages.css">
  <link rel="stylesheet" href="/static/css/matching.css">


  <style>
    /* Prevent a brief flash of the welcome screen when returning to the dashboard. */
    html.skip-welcome #welcome-screen {
      display: none !important;
    }

    html.skip-welcome #main-dashboard {
      display: block !important;
    }

    html.skip-welcome #main-dashboard.hidden {
      display: block !important;
    }

    .show-all-btn {
      font-size: 1rem;
      font-weight: 700;
      padding: 0.72rem 1.15rem;
      border-radius: 0.8rem;
      border: none;
      color: #fff !important;
      text-decoration: none;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.12);
    }

    .show-all-match {
      background: linear-gradient(135deg, #f97316, #fb923c);
    }

    .show-all-circle {
      background: linear-gradient(135deg, #14b8a6, #2dd4bf);
    }
    .show-all-achievements {
      background: linear-gradient(135deg, #0ea5a4, #14b8a6);
    }
    /* Use dedicated event-pill styles so Bootstrap .badge rules never override labels. */
    #dashboard-events-preview .event-pill {
      background: #f8fafc !important;
      color: #111827 !important;
      border: 1px solid #cbd5e1 !important;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.2rem 0.58rem;
      border-radius: 999px;
      font-size: 0.75rem;
      line-height: 1.2;
    }
    #dashboard-events-preview .event-pill.event-pill-gov {
      background: #eff6ff !important;
      color: #111827 !important;
      border-color: #bfdbfe !important;
    }
    #dashboard-events-preview .event-pill.event-pill-corporate {
      background: #fff7ed !important;
      color: #111827 !important;
      border-color: #fdba74 !important;
    }
    /* Force CTA styling for achievements card when Bootstrap .btn defaults are active. */
    #tab-achievements .btn.btn-orange {
      background-color: var(--orange) !important;
      border: 1px solid var(--orange) !important;
      color: #ffffff !important;
      box-shadow: 0 8px 18px rgba(249, 115, 22, 0.28);
    }
    #tab-achievements .btn.btn-orange:hover {
      background-color: var(--orange-dark) !important;
      border-color: var(--orange-dark) !important;
      color: #ffffff !important;
    }
    /* Dedicated CTA class so the button stays visible even with conflicting global styles. */
    #tab-achievements .achievements-cta {
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
      min-height: 44px;
      padding: 0.7rem 1.2rem;
      border-radius: 999px;
      background: #f97316 !important;
      border: 1px solid #f97316 !important;
      color: #ffffff !important;
      text-decoration: none !important;
      font-weight: 700;
      line-height: 1;
      box-shadow: 0 8px 18px rgba(249, 115, 22, 0.28);
    }
    #tab-achievements .achievements-cta:hover {
      background: #ea580c !important;
      border-color: #ea580c !important;
      color: #ffffff !important;
    }

    .matches-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.9rem;
    }
    .dashboard-tabs {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      margin-bottom: 0.8rem;
    }
    .dashboard-tabs .tabs-nav {
      display: flex !important;
      visibility: visible !important;
    }
    .community-feed-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.6rem;
      width: 100%;
      margin: 0;
    }
    .feed-tile {
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      background: #f8fafc;
      aspect-ratio: 1 / 1;
      padding: 0;
    }
    .feed-tile img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .feed-tile-overlay {
      position: absolute;
      inset: auto 0 0 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0), rgba(2, 6, 23, 0.72));
      color: #fff;
      padding: 0.5rem 0.65rem;
      font-size: 0.82rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .feed-tile:hover .feed-tile-overlay { opacity: 1; }
    .feed-empty {
      border: 1px dashed #cbd5e1;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      color: #64748b;
      background: #f8fafc;
      grid-column: 1 / -1;
    }
    .community-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(2, 6, 23, 0.72);
      z-index: 1700;
      padding: 1rem;
    }
    .community-modal.show { display: flex; }
    .community-modal-card {
      background: #fff;
      border-radius: 16px;
      width: min(1020px, 96vw);
      max-height: 92vh;
      overflow: hidden;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      box-shadow: 0 20px 40px rgba(2, 6, 23, 0.28);
      position: relative;
    }
    .community-modal-close {
      position: absolute;
      top: 0.5rem;
      right: 0.7rem;
      border: none;
      background: transparent;
      font-size: 2rem;
      line-height: 1;
      color: #64748b;
    }
    .community-modal-media {
      background: #0f172a;
      min-height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .community-modal-media img {
      width: 100%;
      height: 100%;
      max-height: 92vh;
      object-fit: contain;
    }
    .community-modal-side {
      padding: 1rem;
      display: grid;
      grid-template-rows: auto auto auto 1fr auto;
      gap: 0.8rem;
    }
    .community-user-row {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      font-weight: 700;
    }
    .community-user-avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #e2e8f0;
      background: #fff;
    }
    .community-comments {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: #f8fafc;
      padding: 0.5rem 0.6rem;
      overflow: auto;
      min-height: 150px;
      max-height: 280px;
    }
    .community-comment-item {
      font-size: 0.88rem;
      border-bottom: 1px solid #e2e8f0;
      padding: 0.4rem 0.05rem;
    }
    .community-comment-item:last-child {
      border-bottom: none;
    }
    .community-comment-form {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem;
    }
    .community-comment-form input {
      border: 1px solid #cbd5e1;
      border-radius: 999px;
      padding: 0.52rem 0.85rem;
    }
    @media (max-width: 980px) {
      .community-feed-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .community-modal-card { grid-template-columns: 1fr; }
    }
    @media (max-width: 620px) {
      .community-feed-grid { grid-template-columns: 1fr; }
    }

    .wellbeing-widget {
      margin: 0.45rem 0 0.75rem;
    }
    .smart-welcome {
      background: linear-gradient(135deg, #ecfeff 0%, #ffffff 62%);
      border: 2px solid #d7f3ef;
      border-radius: 20px;
      padding: 24px 28px;
      margin-top: 0.75rem;
      margin-bottom: 1.25rem;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      position: relative;
      overflow: hidden;
    }
    .smart-welcome::after {
      content: "";
      position: absolute;
      right: -70px;
      top: -70px;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(44, 182, 165, 0.14), transparent 65%);
      pointer-events: none;
    }
    .smart-welcome-main {
      z-index: 1;
      min-width: 0;
    }
    .smart-welcome-main h2 {
      margin: 0;
      font-size: 1.62rem;
      font-weight: 800;
      color: #0f172a;
      line-height: 1.15;
    }
    .smart-welcome-context {
      margin: 0.45rem 0 0;
      color: #334155;
      font-weight: 600;
      font-size: 1rem;
    }
    .smart-welcome-support {
      margin: 0.45rem 0 0;
      color: #64748b;
      font-size: 0.95rem;
      font-weight: 600;
    }
    .wellbeing-card {
      background: #ffffff;
      border: 2px solid #d7f3ef;
      border-radius: 14px;
      padding: 12px 16px;
      max-width: none;
      width: 100%;
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
    }
    .wellbeing-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 0.35rem;
    }
    .wellbeing-header h3 {
      margin: 0 0 0.2rem;
      font-size: 1.22rem;
    }
    .wellbeing-actions {
      display: flex;
      gap: 0.45rem;
      flex-wrap: wrap;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .mood-btn {
      border: 1px solid transparent;
      background: transparent;
      padding: 0.25rem 0.45rem;
      border-radius: 999px;
      font-size: 1.05rem;
      line-height: 1;
      font-weight: 600;
      cursor: pointer;
      color: #475569;
      transition: background-color 0.15s ease, color 0.15s ease, transform 0.15s ease;
    }
    .mood-btn:hover {
      background: #f1f5f9;
      color: #0f172a;
      transform: translateY(-1px);
    }
    .mood-btn.active {
      background: #e6fffb;
      color: white;
      color: #0f766e;
      border-color: #99f6e4;
    }
    .wellbeing-summary {
      margin-bottom: 10px;
      color: #334155;
      font-weight: 600;
      font-size: 0.95rem;
    }
    .wellbeing-status {
      display: grid;
      gap: 0.2rem;
      margin-bottom: 10px;
    }
    .wellbeing-status .current {
      font-size: 1.05rem;
      font-weight: 800;
      color: #0f172a;
    }
    .wellbeing-status .last-updated {
      color: #64748b;
      font-size: 0.9rem;
    }
    .wellbeing-trend {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      border-radius: 999px;
      background: #f0fdfa;
      border: 1px solid #bae6e0;
      color: #115e59;
      font-weight: 700;
      padding: 0.25rem 0.7rem;
      margin-bottom: 0.75rem;
    }
    .wellbeing-social {
      margin-bottom: 10px;
      color: #64748b;
      font-size: 0.92rem;
      font-weight: 600;
    }
    .wellbeing-nudge {
      margin-bottom: 10px;
      color: #64748b;
      font-weight: 600;
      font-size: 0.92rem;
    }
    .wellbeing-risk {
      margin-top: 0.7rem;
      padding: 0.6rem 0.75rem;
      border-radius: 12px;
      border: 1px solid #fecaca;
      background: #fef2f2;
      color: #991b1b;
      font-weight: 700;
      font-size: 0.9rem;
      display: none;
    }
    .wellbeing-recos {
      margin-top: 0.2rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }
    .support-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }
    .support-action {
      display: flex;
      align-items: center;
      gap: 0.42rem;
      padding: 0.3rem 0.55rem;
      border-radius: 999px;
      background: transparent;
      border: 1px solid rgba(44, 182, 165, 0.3);
      color: #0f766e;
      font-weight: 700;
      font-size: 0.8rem;
      text-decoration: none;
      transition: transform 0.15s ease, background 0.15s ease;
    }
    .support-action:hover {
      background: rgba(44, 182, 165, 0.12);
      transform: translateY(-1px);
    }
    .support-action .icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      color: #0f766e;
      font-size: 0.8rem;
      border: none;
    }
    .wb-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 16px;
    }
    .wb-overlay.show { display: flex; }
    .wb-modal {
      width: min(520px, 96vw);
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(20, 184, 166, 0.25);
      padding: 18px 18px 14px;
      position: relative;
    }
    .wb-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      cursor: pointer;
    }
    .wb-header {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }
    .wb-icon {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 14px;
      background: linear-gradient(135deg, #f97316, #14b8a6);
      color: #fff;
      font-size: 20px;
    }
    #wbTitle {
      margin: 0;
      font-size: 18px;
    }
    .wb-subtitle {
      margin: 2px 0 0;
      color: #6b7280;
      font-size: 13px;
    }
    .wb-status {
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px;
    }
    .wb-row { display: flex; gap: 10px; align-items: center; }
    .wb-emoji { font-size: 22px; }
    .wb-meta, .wb-muted { color: #6b7280; font-size: 13px; }
    .wb-trend {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .wb-pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(249, 115, 22, 0.35);
      background: rgba(249, 115, 22, 0.08);
      font-size: 13px;
      font-weight: 700;
      color: #7c2d12;
    }
    .wb-week { margin-top: 10px; font-size: 13px; color: #374151; }
    .wb-nudge { margin-top: 10px; font-size: 13px; color: #111827; }
    .wb-moods {
      display: flex;
      gap: 10px;
      padding: 12px 4px 6px;
    }
    .wb-mood {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      cursor: pointer;
      font-size: 20px;
      transition: 0.15s;
    }
    .wb-mood:hover { transform: translateY(-1px); }
    .wb-mood.selected {
      border: none;
      background: linear-gradient(135deg, #f97316, #14b8a6);
      color: #fff;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.14);
    }
    .wb-actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .wb-btn {
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(20, 184, 166, 0.25);
      background: rgba(20, 184, 166, 0.06);
      cursor: pointer;
      font-weight: 600;
      text-align: left;
    }
    .wb-btn:hover { background: rgba(20, 184, 166, 0.12); }
    .wb-optout {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
      font-size: 13px;
      color: #6b7280;
    }
    @media (max-width: 700px) {
      .wellbeing-social { text-align: left; }
    }
  </style>

  <script>
    (function () {
      try {
        if (sessionStorage.getItem('reconnect_dashboard_welcome_shown') === '1') {
          document.documentElement.classList.add('skip-welcome');
        }
      } catch (e) {
        // ignore
      }
    })();
  </script>
  <link rel="stylesheet" href="/static/css/fab.css">
</head>

<body>
  <!-- Accessibility Controls -->
</div>

    <!-- Main Dashboard -->
    <div id="main-dashboard" class="main-dashboard">
    <!-- Top Navbar -->
    <nav class="navbar">
      <div class="container">
        <a href="{{ "/dashboard" if session.get("user_id") else "/" }}" class="logo">
          <div class="logo-circle"></div>
          <span class="logo-text">Re:Connect <span class="logo-sg">SG</span></span>
        </a>

        <ul class="nav-links icon-nav">
          <li class="icon-nav-item">
            <button class="icon-nav-btn" id="notif-btn" type="button" title="Notifications" aria-label="Notifications">
              <span aria-hidden="true">&#x1F514;</span>
              <span class="notification-badge">3</span>
            </button>
          </li>
          <li class="icon-nav-item">
            <a href="/discover" class="icon-nav-link" title="Discover Matches" aria-label="Discover Matches">&#x2764;</a>
          </li>
          <li class="icon-nav-item">
            <a href="/explore" class="icon-nav-link" title="Search" aria-label="Search">&#x1F50D;</a>
          </li>
          <li class="icon-nav-item">
            <a href="/messages" class="icon-nav-link" title="Messages" aria-label="Messages">&#x1F4AC;</a>
          </li>
          <li class="icon-nav-item">
            <a href="/profile" class="icon-nav-link" title="Profile" aria-label="Profile">&#x1F464;</a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Dashboard Content -->
      <main class="dashboard-main">
        <div class="container">
        <div class="smart-welcome" id="smart-welcome" aria-live="polite">
          <div class="smart-welcome-main">
            <h2 id="welcome-greeting"><span id="welcome-time">Good day</span>, <span id="user-name">User</span> &#x1F44B;</h2>
            <p class="smart-welcome-context" id="welcome-context">Ready to connect and learn today?</p>
            <p class="smart-welcome-support" id="welcome-support">We are glad you are here.</p>
          </div>
        </div>

        <div class="stats-cards" aria-label="Your stats">
          <div class="stat-card stat-card-primary">
            <div class="stat-icon">&#x1F4B0;</div>
            <div class="stat-number" id="stat-repoints">{{ repoints_count }}</div>
            <div class="stat-title">Re:Points</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">&#x1F91D;</div>
            <div class="stat-number" id="stat-connections">{{ connections_count }}</div>
            <div class="stat-title">Connections</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">&#x1F4DA;</div>
            <div class="stat-number" id="stat-circles">{{ circles_count }}</div>
            <div class="stat-title">Circles Joined</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">&#x2B50;</div>
            <div class="stat-number" id="stat-badges">{{ badges_count }}</div>
            <div class="stat-title">Badges Earned</div>
          </div>
        </div>

        <!-- Dashboard Tabs -->
        <div class="dashboard-tabs">
          <div class="tabs-nav">
            <button class="tab-button active" data-tab="matches">
              <span class="tab-icon">&#x1F91D;</span>
              <span>Community Feed</span>
            </button>
            <button class="tab-button" data-tab="wisdom-forum">
              <span class="tab-icon">&#x1F4A1;</span>
              <span data-i18n="wisdom_tab">Wisdom Forum</span>
            </button>
            <button class="tab-button" data-tab="learning-circles">
              <span class="tab-icon">&#x1F4DA;</span>
              <span data-i18n="learning_tab">Learning Circles</span>
            </button>
            <button class="tab-button" data-tab="events">
              <span class="tab-icon">&#x1F4C5;</span>
              <span>Events</span>
            </button>
            <button class="tab-button" data-tab="challenges">
              <span class="tab-icon">&#x1F3C6;</span>
              <span data-i18n="challenges_tab">Weekly Challenges</span>
            </button>
            <button class="tab-button" data-tab="achievements">
              <span class="tab-icon">&#x1F3C5;</span>
              <span data-i18n="achievements_tab">Achievements</span>
            </button>
          </div>
        </div>

          <div class="tab-content active" id="tab-matches">
            <div class="section-header section-header-center" style="margin-bottom:0.7rem;">
              <div class="section-header-text">
                <h2>Community Feed</h2>
                <p>Shared community scrapbook moments</p>
              </div>
            </div>
            <div class="chip-row" id="communityFeedScopeChips" style="margin-bottom:0.7rem;">
              <button class="chip active" data-scope="community">Community</button>
              <button class="chip" data-scope="friends">Friends</button>
              <button class="chip" data-scope="featured">Featured</button>
            </div>

            <div class="community-feed-grid" id="communityFeedGrid">
              <div class="feed-empty">Loading community feed...</div>
            </div>

            <div class="community-modal" id="communityFeedModal" aria-hidden="true">
              <div class="community-modal-card modal-card" role="dialog" aria-modal="true" aria-labelledby="communityModalUser">
                <button type="button" class="community-modal-close" id="communityModalClose" aria-label="Close">&times;</button>
                <div class="community-modal-media">
                  <img id="communityModalImage" alt="Community post image">
                </div>
                <div class="community-modal-side">
                  <div class="community-user-row">
                    <img id="communityModalAvatar" class="community-user-avatar" alt="User avatar">
                    <span id="communityModalUser">User</span>
                  </div>
                  <p id="communityModalCaption" style="margin:0; color:#334155;"></p>
                  <div style="display:flex;align-items:center;gap:0.5rem;">
                    <button id="communityModalLikeBtn" class="btn btn-outline-orange btn-sm" type="button">&#x2764; Like</button>
                    <span id="communityModalLikeCount" style="font-weight:700;">0</span>
                  </div>
                  <div class="community-comments" id="communityModalComments"></div>
                  <div class="community-comment-form">
                    <input id="communityModalCommentInput" type="text" maxlength="400" placeholder="Add a comment...">
                    <button id="communityModalCommentSend" class="btn btn-outline-teal btn-sm" type="button">Send</button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        <div class="tab-content" id="tab-wisdom-forum">
              <div class="forum-header section-header-center">
                <div class="section-header-text">
                  <h2>Wisdom Forum</h2>
                  <p>Ask life questions, get wisdom from those who've lived it.</p>
                </div>
                <a href="/forum#ask" class="btn btn-orange btn-sm glow" style="color:#fff;">Ask a Question</a>
              </div>

            <div class="forum-hero">
              <div class="forum-hero-icon">&#x1F4A1;</div>
              <div>
                <div class="forum-hero-title">Get Life Advice from Those Who‚Äôve Lived It</div>
                <div class="forum-hero-text">Ask questions about career, relationships, money, and life. Our senior community members are here to share their wisdom and experience.</div>
                <div class="forum-hero-actions">
                    <a href="/forum" class="btn btn-orange btn-sm">Visit Forum</a>
                  </div>
              </div>
            </div>
            <div style="margin-top: 1rem; background: #fff; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 1rem 1.1rem;">
              <h3 style="font-size: 1rem; margin: 0 0 0.8rem; color: #0f172a;">Recent Discussions</h3>
              {% if posts %}
              <div style="display: grid; gap: 0.7rem;">
                {% for post in posts[:4] %}
                <a href="/forum/posts/{{ post.id }}" style="text-decoration: none; color: inherit; border: 1px solid #e2e8f0; border-radius: 0.8rem; padding: 0.7rem 0.8rem; background: #f8fafc;">
                  <div style="font-weight: 700; color: #0f172a; margin-bottom: 0.2rem;">{{ post.title }}</div>
                  <div style="font-size: 0.86rem; color: #64748b;">{{ post.author }} ¬∑ {{ post.category }} ¬∑ ‚ù§Ô∏è {{ post.likes }} ¬∑ üí¨ {{ post.comment_count or 0 }}</div>
                </a>
                {% endfor %}
              </div>
              {% else %}
              <p style="margin: 0; color: #64748b;">No discussions yet. Be the first to ask a question.</p>
              {% endif %}
            </div>
          </div>
<!-- Tab Content: Learning Circles -->
        <div class="tab-content" id="tab-learning-circles">
          <div class="section-header section-header-center" style="margin-bottom: 2rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
            <div class="section-header-text">
              <h2>Learning Circles</h2>
              <p>Join group sessions to teach and learn together</p>
            </div>
            <a href="/learning-circles" class="btn show-all-btn show-all-circle">Discover</a>
          </div>

          <div class="circles-grid"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
            <!-- Circle Card 1 -->
            <div class="circle-card"
              style="background: white; border-radius: 1.25rem; padding: 1.5rem; border: 2px solid var(--border-color);">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <span style="font-size: 2rem;">&#x1F4F1;</span>
                <div>
                  <span
                    style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">TEACH
                    ME TECH</span>
                </div>
              </div>
              <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 0.5rem;">WhatsApp Basics for Seniors</h3>
              <p style="color: var(--muted-foreground); margin-bottom: 1rem;">Learn to send messages, photos, and voice
                notes with confidence.</p>

              <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                <div
                  style="display: flex; align-items: center; gap: 0.5rem; color: var(--muted-foreground); font-size: 0.875rem;">
                  <span>&#x1F4C5;</span>
                  <span>Today, 3:00 PM</span>
                </div>
                <div
                  style="display: flex; align-items: center; gap: 0.5rem; color: var(--muted-foreground); font-size: 0.875rem;">
                  <span>&#x23F1;&#xFE0F;</span>
                  <span>1 hour</span>
                </div>
                <div
                  style="display: flex; align-items: center; gap: 0.5rem; color: var(--muted-foreground); font-size: 0.875rem;">
                  <span>&#x1F465;</span>
                  <span>8 / 12 participants</span>
                </div>
              </div>

              <button type="button"
                class="join-circle-btn"
                data-circle-title="WhatsApp Basics for Seniors"
                data-circle-time="Today, 3:00 PM"
                data-circle-duration="1 hour"
                style="width: 100%; padding: 0.75rem; background: var(--orange); color: white; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer;">
                Join Circle
              </button>
              <button type="button"
                class="leave-circle-btn"
                data-circle-title="WhatsApp Basics for Seniors"
                style="width: 100%; padding: 0.65rem; background: transparent; color: #e11d48; border: 2px solid #fecdd3; border-radius: 0.75rem; font-weight: 600; cursor: pointer; margin-top: 0.6rem; display: none;">
                Leave Circle
              </button>


            </div>

            <!-- Circle Card 2 -->
            <div class="circle-card"
              style="background: white; border-radius: 1.25rem; padding: 1.5rem; border: 2px solid var(--border-color);">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <span style="font-size: 2rem;">&#x1F4A1;</span>
                <div>
                  <span
                    style="background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">WISDOM
                    HOUR</span>
                </div>
              </div>
              <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 0.5rem;">Stories from 1960s Singapore
              </h3>
              <p style="color: var(--muted-foreground); margin-bottom: 1rem;">Hear firsthand accounts of Singapore's
                kampong days and nation-building years.</p>

              <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                <div
                  style="display: flex; align-items: center; gap: 0.5rem; color: var(--muted-foreground); font-size: 0.875rem;">
                  <span>&#x1F4C5;</span>
                  <span>Tomorrow, 10:00 AM</span>
                </div>
                <div
                  style="display: flex; align-items: center; gap: 0.5rem; color: var(--muted-foreground); font-size: 0.875rem;">
                  <span>&#x23F1;&#xFE0F;</span>
                  <span>1.5 hours</span>
                </div>
                <div
                  style="display: flex; align-items: center; gap: 0.5rem; color: var(--muted-foreground); font-size: 0.875rem;">
                  <span>&#x1F465;</span>
                  <span>15 / 20 participants</span>
                </div>
              </div>
              <button type="button"
                class="join-circle-btn"
                data-circle-title="Stories from 1960s Singapore"
                data-circle-time="Tomorrow, 10:00 AM"
                data-circle-duration="1.5 hours"
                style="width: 100%; padding: 0.75rem; background: var(--teal); color: white; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer;">
                Join Circle
              </button>
              <button type="button"
                class="leave-circle-btn"
                data-circle-title="Stories from 1960s Singapore"
                style="width: 100%; padding: 0.65rem; background: transparent; color: #e11d48; border: 2px solid #fecdd3; border-radius: 0.75rem; font-weight: 600; cursor: pointer; margin-top: 0.6rem; display: none;">
                Leave Circle
              </button>


            </div>

            <!-- Circle Card 3 -->
            <div class="circle-card"
              style="background: white; border-radius: 1.25rem; padding: 1.5rem; border: 2px solid var(--border-color);">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <span style="font-size: 2rem;">&#x1F5E3;&#xFE0F;</span>
                <div>
                  <span
                    style="background: #8b5cf6; color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">LANGUAGE
                    BRIDGES</span>
                </div>
              </div>
              <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 0.5rem;">Hokkien 101: Basic Phrases</h3>
              <p style="color: var(--muted-foreground); margin-bottom: 1rem;">Learn common Hokkien phrases used in
                everyday Singapore life.</p>

              <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                <div
                  style="display: flex; align-items: center; gap: 0.5rem; color: var(--muted-foreground); font-size: 0.875rem;">
                  <span>&#x1F4C5;</span>
                  <span>Friday, 7:00 PM</span>
                </div>
                <div
                  style="display: flex; align-items: center; gap: 0.5rem; color: var(--muted-foreground); font-size: 0.875rem;">
                  <span>&#x23F1;&#xFE0F;</span>
                  <span>1 hour</span>
                </div>
                <div
                  style="display: flex; align-items: center; gap: 0.5rem; color: var(--muted-foreground); font-size: 0.875rem;">
                  <span>&#x1F465;</span>
                  <span>6 / 10 participants</span>
                </div>
              </div>

              <button type="button"
                class="join-circle-btn"
                data-circle-title="Hokkien 101: Basic Phrases"
                data-circle-time="Friday, 7:00 PM"
                data-circle-duration="1 hour"
                style="width: 100%; padding: 0.75rem; background: var(--orange); color: white; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer;">
                Join Circle
              </button>
              <button type="button"
                class="leave-circle-btn"
                data-circle-title="Hokkien 101: Basic Phrases"
                style="width: 100%; padding: 0.65rem; background: transparent; color: #e11d48; border: 2px solid #fecdd3; border-radius: 0.75rem; font-weight: 600; cursor: pointer; margin-top: 0.6rem; display: none;">
                Leave Circle
              </button>

            </div>

          </div>
          <div style="display:flex; justify-content:center; margin-top:1.25rem;">
            <a href="/learning-circles" class="btn btn-orange btn-lg glow" style="min-width: 260px; text-align:center;">Show All Circles</a>
          </div>
        </div>

        <div class="tab-content" id="tab-events">
          <div class="section-header section-header-center" style="margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
            <div class="section-header-text">
              <h2>Events</h2>
              <p>Community events for learning, social connection and wellbeing</p>
            </div>
            <div style="display:flex; gap:0.55rem; flex-wrap:wrap;">
              <a href="/events" class="btn show-all-btn show-all-match" id="open-events-from-events-tab">Open Events</a>
            </div>
          </div>
          <div id="dashboard-events-preview" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.85rem;">
            <div class="empty-state">Loading events...</div>
          </div>
        </div>

                <!-- Tab Content: Weekly Challenges -->
          <div class="tab-content" id="tab-challenges">
            <div class="section-header section-header-center" style="margin-bottom: 2rem;">
              <h2>Weekly Challenges</h2>
              <p>Participate in fun activities and earn Re:Points</p>
            </div>

            <div class="weekly-summary-card">
              <div class="weekly-summary-icon">&#x1F3C6;</div>
              <div class="weekly-summary-body">
                <h3 id="weekly-title">Recreate Your Childhood Snack</h3>
                <p id="weekly-description">Cook or buy a snack from your childhood and share the story behind it!</p>
                <div class="weekly-summary-grid">
                  <div>
                    <div class="label">Deadline</div>
                    <div class="value" id="weekly-deadline">3 days left</div>
                  </div>
                  <div>
                    <div class="label">Participants</div>
                    <div class="value" id="weekly-participants">45</div>
                  </div>
                  <div>
                    <div class="label">Submissions</div>
                    <div class="value" id="weekly-submissions">23</div>
                  </div>
                </div>
                <div class="weekly-summary-actions">
                  <a href="/challenges" class="btn btn-orange btn-sm weekly-cta">Submit Entry (+20 points)</a>
                  <a href="/challenges#submissions" class="weekly-link">View Submissions</a>
                </div>
              </div>
            </div>
          </div>

<!-- Tab Content: Achievements -->
        <div class="tab-content" id="tab-achievements">
          <div class="section-header" style="margin-bottom: 2rem;">
            <h2>Achievements</h2>
            <p>Track your milestones, quests, and rewards in your gamification hub.</p>
          </div>

          <div style="background: white; border-radius: 1.5rem; padding: 2rem; border: 2px solid var(--border-color);">
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem;">Your Achievements Hub</h3>
            <p style="color: var(--muted-foreground); margin-bottom: 1.5rem;">
              View your badges, quests, and progress map in one place.
            </p>
            <a href="/achievements" class="btn btn-orange glow achievements-cta">See your achievements</a>
          </div>
        </div>

        

      </div>
    </main>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav">
      <a href="/dashboard" class="bottom-nav-item active">
        <span class="nav-icon">&#x1F3E0;</span>
        <span class="nav-label" data-i18n="nav_home">Home</span>
      </a>
      <a href="/explore" class="bottom-nav-item">
        <span class="nav-icon">&#x1F50D;</span>
        <span class="nav-label">Explore</span>
      </a>
      <a href="/messages" class="bottom-nav-item">
        <span class="nav-icon">&#x1F4AC;</span>
        <span class="nav-label" data-i18n="nav_messages">Messages</span>
      </a>
      <a href="/profile" class="bottom-nav-item">
        <span class="nav-icon">&#x1F464;</span>
        <span class="nav-label" data-i18n="nav_profile">Profile</span>
      </a>
    </nav>
  </div>

  <!-- Notifications Dropdown -->
  <div class="notifications-dropdown" id="notifications-dropdown">
    <div class="notifications-header">
      <h3>Notifications</h3>
      <button class="mark-read-btn">Mark all as read</button>
    </div>
    <div class="notifications-list" id="notifications-list"></div>
  </div>

  <!-- Language Modal -->
  <div class="modal" id="lang-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Select Language / √©‚Ç¨‚Ä∞√¶‚Äπ¬©√®¬Ø¬≠√®¬®‚Ç¨</h3>
        <button class="close-modal" id="close-lang-modal">&times;</button>
      </div>
      <div class="lang-options">
        <button class="lang-option-big" data-lang="en">
          <span class="lang-flag">&#x1F1EC;&#x1F1E7;</span>
          <span class="lang-name">English</span>
        </button>
        <button class="lang-option-big" data-lang="zh">
          <span class="lang-flag">&#x1F1E8;&#x1F1F3;</span>
          <span class="lang-name">√§¬∏¬≠√¶‚Äì‚Ä° (Chinese)</span>
        </button>
        <button class="lang-option-big" data-lang="ms">
          <span class="lang-flag">&#x1F1F2;&#x1F1FE;</span>
          <span class="lang-name">Bahasa Melayu</span>
        </button>
        <button class="lang-option-big" data-lang="ta">
          <span class="lang-flag">&#x1F1EE;&#x1F1F3;</span>
          <span class="lang-name">√†¬Æ¬§√†¬Æ¬Æ√†¬Æ¬ø√†¬Æ¬¥√†¬Ø¬ç (Tamil)</span>
        </button>
      </div>
    </div>
  </div>

  <div class="ui-modal" id="ui-modal">
    <div class="ui-modal-card">
      <div class="ui-modal-header">
        <h3 id="ui-modal-title">Title</h3>
        <button class="ui-modal-close" id="ui-modal-close">&#x2716;</button>
      </div>
      <div class="ui-modal-body" id="ui-modal-body"></div>
      <div class="ui-modal-actions" id="ui-modal-actions"></div>
    </div>
  </div>

  <div id="wbOverlay" class="wb-overlay" aria-hidden="true">
    <div class="wb-modal" role="dialog" aria-modal="true" aria-labelledby="wbTitle">
      <button class="wb-close" id="wbClose" aria-label="Close check-in">&#x2715;</button>
      <div class="wb-header">
        <div class="wb-icon">&#x1F49B;</div>
        <div>
          <h3 id="wbTitle">Quick emotional check-in</h3>
          <p class="wb-subtitle">with smart support nudges.</p>
        </div>
      </div>

      <div class="wb-status">
        <div class="wb-row">
          <span class="wb-emoji" id="wbMoodEmoji">&#x1F610;</span>
          <div>
            <div class="wb-feeling"><b id="wbMoodLabel">Feeling Neutral</b></div>
            <div class="wb-meta">Last check-in: <span id="wbLastCheckin">No check-ins yet</span></div>
          </div>
        </div>
        <div class="wb-trend">
          <span class="wb-pill" id="wbTrendPill">&#x27A1; Stable</span>
          <span class="wb-muted" id="wbTrendText">Trend: Stable this week.</span>
        </div>
        <div class="wb-week" id="wbWeek">This week: <b>0</b> circles ‚Ä¢ <b>0</b> messages ‚Ä¢ <b>0</b> challenges</div>
        <div class="wb-nudge" id="wbNudge">You have not interacted this week. Say hi to a buddy?</div>
      </div>

      <div class="wb-moods" aria-label="Select mood">
        <button class="wb-mood" data-mood="happy" aria-label="Happy">&#x1F60A;</button>
        <button class="wb-mood" data-mood="good" aria-label="Good">&#x1F642;</button>
        <button class="wb-mood" data-mood="neutral" aria-label="Neutral">&#x1F610;</button>
        <button class="wb-mood" data-mood="stressed" aria-label="Stressed">&#x1F61F;</button>
        <button class="wb-mood" data-mood="sad" aria-label="Sad">&#x1F61E;</button>
      </div>

      <div class="wb-actions">
        <button class="wb-btn" data-action="circle">&#x1F4DA; Join a Support Circle</button>
        <button class="wb-btn" data-action="buddy">&#x1F91D; Message a Buddy Match</button>
        <button class="wb-btn" data-action="stories">&#x1F9E0; Read encouraging stories</button>
      </div>

      <label class="wb-optout">
        <input type="checkbox" id="wbDontShowToday">
        Don&#8217;t show again today
      </label>
    </div>
  </div>

  <script src="/static/js/dashboard.js"></script>
  <script src="/static/js/tabs.js"></script>
  <script src="/static/js/messages.js"></script>
  <script src="/static/js/matching.js"></script>
  <script>window.CSRF_TOKEN = {{ csrf_token|tojson }};</script>
  <script src="/static/js/matches_feed.js"></script>
  <script src="/static/js/forum.js?v=20260215b"></script>
    <script src="/static/js/challenges.js?v=20260215d"></script>
    <script src="/static/js/notifications.js"></script>
    <script>
      (function () {
        var overlay = document.getElementById('wbOverlay');
        var closeBtn = document.getElementById('wbClose');
        var dontShowToday = document.getElementById('wbDontShowToday');
        var trendPill = document.getElementById('wbTrendPill');
        var trendText = document.getElementById('wbTrendText');
        var moodLabel = document.getElementById('wbMoodLabel');
        var moodEmoji = document.getElementById('wbMoodEmoji');
        var weekEl = document.getElementById('wbWeek');
        var nudgeEl = document.getElementById('wbNudge');
        var lastCheckinEl = document.getElementById('wbLastCheckin');

        if (!overlay || !closeBtn) return;

        function demoHeaders(extra) {
          var headers = extra ? Object.assign({}, extra) : {};
          var demoId = sessionStorage.getItem('demo_user_id');
          if (demoId) headers['X-Demo-User'] = demoId;
          return headers;
        }

        function shouldShow() {
          return true;
        }

        function markShownToday() {
          try { localStorage.removeItem('wb_last_shown_day'); } catch (e) {}
        }

        function hideModal() {
          overlay.classList.remove('show');
          overlay.setAttribute('aria-hidden', 'true');
        }

        function showModal() {
          overlay.classList.add('show');
          overlay.setAttribute('aria-hidden', 'false');
        }

        function moodMeta(mood) {
          var map = {
            happy: { emoji: 'üòä', label: 'Feeling Happy' },
            good: { emoji: 'üôÇ', label: 'Feeling Good' },
            neutral: { emoji: 'üòê', label: 'Feeling Neutral' },
            stressed: { emoji: 'üòü', label: 'Feeling Stressed' },
            sad: { emoji: 'üòû', label: 'Feeling Sad' }
          };
          return map[mood] || map.neutral;
        }

        function hydrateModal() {
          fetch('/api/wellbeing/dashboard', { headers: demoHeaders() })
            .then(function (res) { return res.ok ? res.json() : null; })
            .then(function (data) {
              if (!data || !data.ok) return;
              var checkin = data.latest_checkin || {};
              var meta = moodMeta(checkin.mood || 'neutral');
              if (moodLabel) moodLabel.textContent = meta.label;
              if (moodEmoji) moodEmoji.textContent = meta.emoji;
              if (lastCheckinEl) lastCheckinEl.textContent = data.last_updated_human || 'No check-ins yet';
              if (trendPill) trendPill.textContent = (data.trend && (data.trend.arrow + ' ' + data.trend.label)) || '‚û° Stable';
              if (trendText) trendText.textContent = 'Trend: ' + ((data.trend && data.trend.label) || 'Stable') + ' this week.';
              if (data.activity && weekEl) {
                weekEl.innerHTML = 'This week: <b>' + (data.activity.circles || 0) + '</b> circles ‚Ä¢ <b>' + (data.activity.messages || 0) + '</b> messages ‚Ä¢ <b>' + (data.activity.challenges || 0) + '</b> challenges';
              }
              if (nudgeEl) nudgeEl.textContent = data.nudge || 'You have not interacted this week. Say hi to a buddy?';
            })
            .catch(function () {});
        }

        function closeAndMaybePersist() {
          if (dontShowToday && dontShowToday.checked) {
            localStorage.setItem('wb_hide_until', String(Date.now() + 24 * 60 * 60 * 1000));
          }
          hideModal();
        }

        window.addEventListener('load', function () {
          hydrateModal();
          if (shouldShow()) {
            showModal();
            markShownToday();
          }
        });

        closeBtn.addEventListener('click', closeAndMaybePersist);

        overlay.addEventListener('click', function (e) {
          if (e.target === overlay) hideModal();
        });

        document.querySelectorAll('.wb-mood').forEach(function (btn) {
          btn.addEventListener('click', function () {
            document.querySelectorAll('.wb-mood').forEach(function (b) { b.classList.remove('selected'); });
            btn.classList.add('selected');
            var selectedMood = btn.dataset.mood || 'neutral';
            fetch('/api/wellbeing/checkin', {
              method: 'POST',
              headers: demoHeaders({ 'Content-Type': 'application/json' }),
              body: JSON.stringify({ mood: selectedMood })
            }).catch(function () {});
            setTimeout(hideModal, 300);
          });
        });

        document.querySelectorAll('.wb-btn').forEach(function (btn) {
          btn.addEventListener('click', function () {
            hideModal();
            var action = btn.dataset.action;
            if (action === 'circle') window.location.href = '/learning-circles';
            if (action === 'buddy') window.location.href = '/messages';
            if (action === 'stories') window.location.href = '/wellbeing';
          });
        });

        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape' && overlay.classList.contains('show')) hideModal();
        });
      })();
    </script>
  
      <script>
        // Show a short welcome splash only once per browser tab/session.
    // Behaviour:
    // - If user is logged in: show either "Welcome back" (login) or "Welcome ! <name>" (first-time sign-up)
    // - If not logged in: skip the splash entirely.
    (function () {
      var KEY = 'reconnect_dashboard_welcome_shown';

      function showDashboard() {
        var welcome = document.getElementById('welcome-screen');
        var main = document.getElementById('main-dashboard');

        if (welcome) welcome.style.display = 'none';
        if (main) main.classList.remove('hidden');
      }

      function safeParse(jsonText) {
        try { return JSON.parse(jsonText); } catch (e) { return null; }
      }

      function setWelcomeHeadline(text) {
        var welcome = document.getElementById('welcome-screen');
        if (!welcome) return;
        var h1 = welcome.querySelector('h1');
        if (h1) h1.textContent = text || '';
      }

      function setNavAvatar(name) {
        var img = document.querySelector('img.nav-avatar');
        if (!img) return;
        if (img.dataset && img.dataset.sessionAvatar === '1') return;
        var seed = (name && String(name).trim().length) ? String(name).trim() : 'User';
        img.src = 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + encodeURIComponent(seed);
        img.alt = 'Profile';
      }

        document.addEventListener('DOMContentLoaded', function () {
          // Skip the welcome splash to avoid a white flash on load.
          showDashboard();
          return;

          var auth = safeParse(localStorage.getItem('reconnect_auth') || '') || {};
          var user = safeParse(localStorage.getItem('reconnect_user') || '') || {};

        setNavAvatar(user.name);

        var isLoggedIn = !!auth.loggedIn;
        if (!isLoggedIn) {
          // Not logged in: skip splash and just show the dashboard content.
          showDashboard();
          return;
        }

        var alreadyShown = false;
        try { alreadyShown = sessionStorage.getItem(KEY) === '1'; } catch (e) { alreadyShown = false; }

        // Decide the correct headline.
        var headline = 'Welcome back';
        if (user && user.isNewSignup) {
          var nm = user.name ? String(user.name).trim() : '';
          headline = nm ? ('Welcome! ' + nm) : 'Welcome!';
        }
        setWelcomeHeadline(headline);

        if (alreadyShown) {
          showDashboard();
          return;
        }

        // Mark as shown immediately so navigating away and returning won't show it again.
        try { sessionStorage.setItem(KEY, '1'); } catch (e) { }

        // If this was a fresh sign-up, flip the flag so future logins get "Welcome back".
        if (user && user.isNewSignup) {
          try {
            user.isNewSignup = false;
            localStorage.setItem('reconnect_user', JSON.stringify(user));
          } catch (e) { }
        }

        // Ensure splash is visible, then reveal after a short delay.
        var main = document.getElementById('main-dashboard');
        var welcome = document.getElementById('welcome-screen');
        if (main) main.classList.add('hidden');
        if (welcome) welcome.style.display = '';

        window.setTimeout(function () {
          showDashboard();
        }, 1500);
      });
    })();
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      function activateTab(tabKey) {
        var buttons = document.querySelectorAll('.tab-button');
        var panels = document.querySelectorAll('.tab-content');

        buttons.forEach(function (b) {
          b.classList.toggle('active', b.getAttribute('data-tab') === tabKey);
        });

        panels.forEach(function (p) {
          p.classList.toggle('active', p.id === ('tab-' + tabKey));
        });

        var tabsBar = document.querySelector('.dashboard-tabs');
        if (tabsBar) tabsBar.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      document.querySelectorAll('.join-circle-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var title = btn.getAttribute('data-circle-title');
          var time = btn.getAttribute('data-circle-time');
          var duration = btn.getAttribute('data-circle-duration');
          if (title) {
            if (typeof window.joinCircle === 'function') {
              window.joinCircle(title, time, duration);
            }
            return;
          }
          var target = btn.getAttribute('data-go-tab') || 'challenges';
          activateTab(target);
        });
      });

      document.querySelectorAll('.leave-circle-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var title = btn.getAttribute('data-circle-title');
          if (title && typeof window.leaveCircle === 'function') {
            window.leaveCircle(title);
          }
        });
      });

      function escHtml(text) {
        return String(text || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function formatEventDateTime(value) {
        if (!value) return '';
        var dt = new Date(value);
        if (isNaN(dt.getTime())) return String(value);
        return dt.toLocaleString([], {
          weekday: 'short',
          day: 'numeric',
          month: 'short',
          hour: 'numeric',
          minute: '2-digit'
        });
      }

      function eventBadgeClass(kind) {
        var k = String(kind || '').toLowerCase();
        if (k === 'government') return 'event-pill event-pill-gov';
        if (k === 'corporate') return 'event-pill event-pill-corporate';
        return 'event-pill';
      }

      async function loadDashboardEventsPreview() {
        var wrap = document.getElementById('dashboard-events-preview');
        if (!wrap) return;
        try {
          var res = await fetch('/api/events');
          var out = await res.json();
          var events = (out && out.ok && Array.isArray(out.events)) ? out.events.slice(0, 4) : [];
          if (!events.length) {
            wrap.innerHTML = '<div class="empty-state">No events available yet.</div>';
            return;
          }
          wrap.innerHTML = events.map(function (e) {
            var badgeCls = eventBadgeClass(e.organiser_type);
            var badgeText = escHtml(e.verification_badge || 'Community Hosted');
            var startLabel = escHtml(formatEventDateTime(e.start_time));
            return (
              '<article style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:0.85rem;display:flex;flex-direction:column;min-height:236px;">' +
                '<div style="font-weight:700;color:#0f172a;line-height:1.3;min-height:3.05rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">' + escHtml(e.title) + '</div>' +
                '<div style="font-size:0.85rem;color:#334155;margin-top:0.22rem;">' + escHtml(e.category) + ' ¬∑ ' + startLabel + '</div>' +
                '<div style="margin-top:0.35rem;display:flex;gap:0.35rem;align-items:center;flex-wrap:wrap;min-height:2rem;">' +
                  '<span class="' + badgeCls + '" style="color:#111827 !important;">' + badgeText + '</span>' +
                '</div>' +
                '<div style="font-size:0.86rem;color:#334155;margin-top:auto;padding-top:0.35rem;line-height:1.35;">' + escHtml(e.location_name || '') + '</div>' +
              '</article>'
            );
          }).join('');
        } catch (e) {
          wrap.innerHTML = '<div class="empty-state">Could not load events.</div>';
        }
      }
      loadDashboardEventsPreview();
      });
    </script>
<script>
    function demoHeaders(extra) {
      var headers = extra ? Object.assign({}, extra) : {};
      try {
        var demoId = sessionStorage.getItem('demo_user_id');
        if (demoId) headers['X-Demo-User'] = demoId;
      } catch (e) {}
      return headers;
    }

    async function joinCircle(title, time, duration) {
      try {
        var res = await fetch('/api/circle_signup', {
          method: 'POST',
          headers: demoHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ title: title, time: time, duration: duration })
        });

        var out = await res.json().catch(function () { return {}; });
        if (!res.ok) {
          alert(out.error || 'Could not join this circle');
          return;
        }
        window.location.href = '/circle-confirmation?title=' + encodeURIComponent(title)
          + '&time=' + encodeURIComponent(time)
          + '&duration=' + encodeURIComponent(duration);
      } catch (err) {
        alert('Could not reach the server. Please try again.');
      }
    }

    async function leaveCircle(title) {
      try {
        var res = await fetch('/api/circle_leave', {
          method: 'POST',
          headers: demoHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ title: title })
        });
        var out = await res.json().catch(function () { return {}; });
        if (!res.ok || !out.ok) {
          alert(out.error || 'Could not leave this circle');
          return;
        }
        await loadJoinedCircles();
      } catch (err) {
        alert('Could not reach the server. Please try again.');
      }
    }

    async function loadJoinedCircles() {
      try {
        var res = await fetch('/api/circle_signups', { headers: demoHeaders() });
        var out = await res.json().catch(function () { return {}; });
        if (!res.ok || !out.ok) return;
        var titles = (out.circles || []).map(function (c) { return c.title; });
        document.querySelectorAll('.join-circle-btn').forEach(function (btn) {
          var title = btn.getAttribute('data-circle-title');
          if (title && titles.indexOf(title) !== -1) {
            btn.textContent = 'Joined';
            btn.disabled = true;
            btn.style.background = '#94a3b8';
            btn.style.cursor = 'default';
          }
        });
        document.querySelectorAll('.leave-circle-btn').forEach(function (btn) {
          var title = btn.getAttribute('data-circle-title');
          var joined = title && titles.indexOf(title) !== -1;
          btn.style.display = joined ? 'block' : 'none';
        });
      } catch (e) {
      }
    }

    document.addEventListener('DOMContentLoaded', loadJoinedCircles);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% include "partials/fab.html" %}
  <script src="/static/js/fab.js"></script>
</body>

</html>




