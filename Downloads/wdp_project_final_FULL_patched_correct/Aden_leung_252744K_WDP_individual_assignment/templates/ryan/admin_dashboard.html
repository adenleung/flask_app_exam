<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Re:Connect SG</title>

  <link rel="stylesheet" href="/static/ryan/css/styles.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .admin-wrap { padding: 32px 0 60px; }
    .admin-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; }
    .admin-header h1 { margin: 0; font-size: 1.6rem; }
    .admin-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .card {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 1.25rem;
      padding: 1.25rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      margin-top: 16px;
    }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .stat { padding: 14px; border-radius: 1rem; background: var(--muted); border: 1px solid rgba(0,0,0,0.06); }
    .stat .k { font-size: 0.85rem; color: var(--muted-foreground); }
    .stat .v { font-size: 1.4rem; font-weight: 800; margin-top: 4px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
    th, td { padding: 10px 10px; border-bottom: 1px solid rgba(0,0,0,0.08); text-align: left; vertical-align: top; }
    th { font-size: 0.85rem; color: var(--muted-foreground); font-weight: 800; }
    .muted { color: var(--muted-foreground); }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-weight: 800; font-size: 0.78rem; border: 1px solid rgba(0,0,0,0.12); background: white; }
    .pill.login { border-color: rgba(22,163,165,0.35); }
    .pill.signup { border-color: rgba(249,115,22,0.35); }
    .section-title { margin: 0 0 10px; font-size: 1.15rem; }
    .table-wrap { overflow-x: auto; }
    .error { color: #b91c1c; font-weight: 700; }
  </style>
  <link rel="stylesheet" href="/static/shared/dialogs.css">
</head>

<body>
  <nav class="navbar">
    <div class="container">
      <a href="/" class="logo">
        <div class="logo-circle"></div>
        <span class="logo-text">Re:Connect SG</span>
      </a>

      <ul class="nav-links">
        <li><a href="/ryan/admin-dashboard" class="active">Admin</a></li>
        <li><a href="/ryan/dashboard">User Home</a></li>
      </ul>
    </div>
  </nav>

  <main class="admin-wrap">
    <div class="container" style="max-width: 1100px;">
      <div class="admin-header">
        <div>
          <h1>Admin Dashboard</h1>
          <div class="muted" style="margin-top: 6px;">View recent logins, signups, and learning circle joins.</div>
        </div>
        <div class="admin-actions">
          <button class="btn btn-outline-teal" id="refreshBtn">Refresh</button>
          <button class="btn btn-orange" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="card">
        <div class="stats" id="stats"></div>
      </div>

      <div class="card">
        <h2 class="section-title">Logins and signups (latest 200)</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date/Time</th>
                <th>Type</th>
                <th>User</th>
                <th>Email</th>
                <th>IP</th>
              </tr>
            </thead>
            <tbody id="authBody">
              <tr><td colspan="5" class="muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2 class="section-title">Learning circle signups (latest 200)</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date/Time</th>
                <th>User</th>
                <th>Circle</th>
                <th>Time</th>
                <th>Duration</th>
                <th>IP</th>
              </tr>
            </thead>
            <tbody id="circleBody">
              <tr><td colspan="6" class="muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2 class="section-title">Open in DB Browser (SQLite)</h2>
        <div class="muted" style="line-height: 1.6;">
          Database file: <strong>instance/reconnect.db</strong><br />
          Tables: <strong>users</strong>, <strong>user_settings</strong>, <strong>auth_events</strong>, <strong>circle_signups</strong>
        </div>
      </div>

      <div id="errorBox" class="error" style="margin-top: 14px;"></div>
    </div>
  </main>

  <script>
    function esc(s) {
      return (s || '').toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function pill(type) {
      var cls = type === 'signup' ? 'signup' : 'login';
      return '<span class="pill ' + cls + '">' + esc(type) + '</span>';
    }

    function fmtIso(iso) {
      if (!iso) return '';
      try {
        var d = new Date(iso);
        return d.toLocaleString();
      } catch (e) {
        return iso;
      }
    }

    async function loadOverview() {
      var errorBox = document.getElementById('errorBox');
      errorBox.textContent = '';

      try {
        var res = await fetch('/ryan/api/admin/overview');
        var out = await res.json().catch(function () { return {}; });

        if (!res.ok || !out.ok) {
          errorBox.textContent = out.error || 'Not authorised. Please log in again.';
          document.getElementById('authBody').innerHTML = '<tr><td colspan="5" class="muted">-</td></tr>';
          document.getElementById('circleBody').innerHTML = '<tr><td colspan="6" class="muted">-</td></tr>';
          return;
        }

        var stats = out.stats || {};
        document.getElementById('stats').innerHTML = [
          '<div class="stat"><div class="k">Total users</div><div class="v">' + esc(stats.total_users) + '</div></div>',
          '<div class="stat"><div class="k">Total logins/signups</div><div class="v">' + esc(stats.total_auth_events) + '</div></div>',
          '<div class="stat"><div class="k">Total circle signups</div><div class="v">' + esc(stats.total_circle_signups) + '</div></div>'
        ].join('');

        var authRows = (out.auth_events || []).map(function (e) {
          return '<tr>' +
            '<td>' + esc(fmtIso(e.created_at)) + '</td>' +
            '<td>' + pill(e.event_type) + '</td>' +
            '<td>' + esc(e.user_name || ('User #' + e.user_id)) + '</td>' +
            '<td>' + esc(e.email) + '</td>' +
            '<td class="muted">' + esc(e.ip_address) + '</td>' +
          '</tr>';
        }).join('');

        document.getElementById('authBody').innerHTML = authRows || '<tr><td colspan="5" class="muted">No records yet</td></tr>';

        var circleRows = (out.circle_signups || []).map(function (s) {
          return '<tr>' +
            '<td>' + esc(fmtIso(s.created_at)) + '</td>' +
            '<td>' + esc(s.user_name || ('User #' + s.user_id)) + '</td>' +
            '<td>' + esc(s.circle_title) + '</td>' +
            '<td>' + esc(s.circle_time) + '</td>' +
            '<td>' + esc(s.circle_duration) + '</td>' +
            '<td class="muted">' + esc(s.ip_address) + '</td>' +
          '</tr>';
        }).join('');

        document.getElementById('circleBody').innerHTML = circleRows || '<tr><td colspan="6" class="muted">No records yet</td></tr>';
      } catch (err) {
        errorBox.textContent = 'Could not load admin data. Please try again.';
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', loadOverview);

    document.getElementById('logoutBtn').addEventListener('click', async function () {
      try {
        await fetch('/ryan/api/admin/logout', { method: 'POST' });
      } catch (e) {}
      window.location.href = '/admin-login';
    });

    loadOverview();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/shared/dialogs.js"></script>
</body>
</html>
